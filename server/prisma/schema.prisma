// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  MANAGER
  USER
  VIEWER
}

model User {
  id                    Int                  @id @default(autoincrement())
  email                 String               @unique
  password              String
  name                  String?
  role                  UserRole             @default(USER)
  invoices              Invoice[]
  mcpApiTokens          McpApiToken[]
  uploadedFiles         FileAttachment[]
  validationOverrides   ValidationOverride[]

  // Refresh token support
  refreshToken          String?              @unique
  refreshTokenExpiresAt DateTime?
  lastLoginAt           DateTime?
  loginAttempts         Int                  @default(0)
  lockedUntil           DateTime?

  @@index([refreshToken])
  @@index([lockedUntil])
}

model McpApiToken {
  id          Int       @id @default(autoincrement())
  name        String    // User-provided name (e.g., "Claude Desktop")
  tokenHash   String    // bcrypt hash of the token (for verification)
  lookupHash  String?   @unique // SHA-256 hash (for O(1) lookup) - nullable for migration
  tokenPrefix String    // First 12 chars for display (without ellipsis - UI adds it)
  userId      Int
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt   DateTime
  lastUsedAt  DateTime?
  createdAt   DateTime  @default(now())
  revokedAt   DateTime? // Soft delete - when null, token is active

  @@index([userId])
  @@index([userId, revokedAt])
  @@index([expiresAt])
}

model Vendor {
  id             Int             @id @default(autoincrement())
  name           String
  contact        String?
  deletedAt      DateTime?
  items          Item[]
  purchaseOrders PurchaseOrder[]
  deliveryNotes  DeliveryNote[]
  // Analytics relations
  spendingMetrics SpendingMetric[]
  priceSnapshots  PriceSnapshot[]

  @@index([deletedAt])
  @@index([name])
}

model Item {
  id                Int                 @id @default(autoincrement())
  name              String
  item_code         String?
  price             Float // Current price
  vendorId          Int
  deletedAt         DateTime?
  vendor            Vendor              @relation(fields: [vendorId], references: [id])
  invoiceItems      InvoiceItem[]
  priceHistory      ItemPriceHistory[]
  poItems           PurchaseOrderItem[]
  deliveryNoteItems DeliveryNoteItem[]
  // Analytics relations
  spendingMetrics   SpendingMetric[]
  purchasePatterns  PurchasePattern[]
  priceSnapshots    PriceSnapshot[]

  @@unique([vendorId, item_code])
  @@index([vendorId])
  @@index([deletedAt])
  @@index([vendorId, deletedAt])
}

model ItemPriceHistory {
  id     Int      @id @default(autoincrement())
  itemId Int
  item   Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  price  Float
  date   DateTime @default(now())

  @@index([itemId])
  @@index([date])
  @@index([itemId, date])
}

model PurchaseOrder {
  id            Int                 @id @default(autoincrement())
  vendorId      Int
  vendor        Vendor              @relation(fields: [vendorId], references: [id])
  date          DateTime            @default(now())
  status        String              @default("DRAFT") // DRAFT, SENT, FULFILLED
  deletedAt     DateTime?
  items         PurchaseOrderItem[]
  invoices      Invoice[]
  deliveryNotes DeliveryNote[]

  @@index([status])
  @@index([deletedAt])
  @@index([date])
  @@index([vendorId])
}

model PurchaseOrderItem {
  id              Int           @id @default(autoincrement())
  purchaseOrderId Int
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  itemId          Int
  item            Item          @relation(fields: [itemId], references: [id])
  quantity        Int
  price           Float // Price at the time of PO creation

  @@index([purchaseOrderId, itemId]) // JOIN optimization
}

model Invoice {
  id              Int                   @id @default(autoincrement())
  invoiceNumber   String?               // Invoice number from vendor
  vendorId        Int?                  // Denormalized for validation performance
  date            DateTime              @default(now())
  status          String                @default("PENDING") // PENDING, APPROVED, REJECTED
  totalAmount     Float                 @default(0)
  userId          Int?
  user            User?                 @relation(fields: [userId], references: [id])
  project         String?
  accountingId    String?
  syncStatus      String                @default("PENDING") // PENDING, SYNCED, FAILED
  syncError       String?
  deletedAt       DateTime?
  items           InvoiceItem[]
  purchaseOrderId Int?
  purchaseOrder   PurchaseOrder?        @relation(fields: [purchaseOrderId], references: [id])
  deliveryNotes   InvoiceDeliveryLink[]
  validations     InvoiceValidation[]

  branchId     Int?
  branch       Branch?     @relation(fields: [branchId], references: [id])
  departmentId Int?
  department   Department? @relation(fields: [departmentId], references: [id])
  costCenterId Int?
  costCenter   CostCenter? @relation(fields: [costCenterId], references: [id])

  @@unique([invoiceNumber, vendorId])
  @@index([status])
  @@index([deletedAt])
  @@index([date])
  @@index([syncStatus])
  @@index([branchId])
  @@index([departmentId])
  @@index([costCenterId])
  @@index([invoiceNumber])
  @@index([vendorId])
  @@index([invoiceNumber, vendorId, deletedAt])
  @@index([status, deletedAt])
  @@index([status, date, deletedAt])        // Spending analytics
  @@index([status, departmentId, deletedAt]) // Department breakdown
  @@index([status, branchId, deletedAt])     // Branch breakdown
}

model InvoiceItem {
  id        Int     @id @default(autoincrement())
  invoiceId Int
  invoice   Invoice @relation(fields: [invoiceId], references: [id])
  itemId    Int
  item      Item    @relation(fields: [itemId], references: [id])
  quantity  Int
  price     Float // Price at the time of invoice

  @@index([invoiceId])
  @@index([itemId])
  @@index([invoiceId, itemId]) // JOIN optimization
}

model IntegrationConfig {
  id      Int     @id @default(autoincrement())
  key     String  @unique // e.g. "XERO"
  enabled Boolean @default(false)
  config  String? // JSON stringified credentials
}

model Branch {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  invoices Invoice[]
  // Analytics relations
  spendingMetrics  SpendingMetric[]
  purchasePatterns PurchasePattern[]
  priceSnapshots   PriceSnapshot[]
}

model Department {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  costCenters CostCenter[]
  invoices    Invoice[]
  // Analytics relations
  spendingMetrics SpendingMetric[]
}

model CostCenter {
  id           Int        @id @default(autoincrement())
  name         String     @unique
  departmentId Int
  department   Department @relation(fields: [departmentId], references: [id])
  invoices     Invoice[]
  // Analytics relations
  spendingMetrics SpendingMetric[]
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int?
  action    String
  entity    String
  entityId  Int
  changes   String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([entity, entityId])
  @@index([userId])
  @@index([createdAt])
  @@index([action])
  @@index([entity, entityId, createdAt]) // Entity history queries
}

// ============================================
// DELIVERY NOTE MODELS
// ============================================

enum DeliveryNoteStatus {
  DRAFT
  CONFIRMED
}

enum ItemCondition {
  GOOD
  DAMAGED
  PARTIAL
}

model DeliveryNote {
  id              Int                   @id @default(autoincrement())
  deliveryDate    DateTime
  receivedBy      String // Name of person who received goods
  notes           String?
  status          DeliveryNoteStatus    @default(DRAFT)

  // Relationships
  purchaseOrderId Int
  purchaseOrder   PurchaseOrder         @relation(fields: [purchaseOrderId], references: [id])

  vendorId        Int
  vendor          Vendor                @relation(fields: [vendorId], references: [id])

  items           DeliveryNoteItem[]
  invoices        InvoiceDeliveryLink[] // N:N with Invoice

  // Audit
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  createdBy       Int // User ID

  @@index([purchaseOrderId])
  @@index([vendorId])
  @@index([status])
  @@index([deliveryDate])
}

model DeliveryNoteItem {
  id                  Int            @id @default(autoincrement())

  deliveryNoteId      Int
  deliveryNote        DeliveryNote   @relation(fields: [deliveryNoteId], references: [id], onDelete: Cascade)

  itemId              Int
  item                Item           @relation(fields: [itemId], references: [id])

  quantityOrdered     Int // From PO
  quantityDelivered   Int // Actually received
  condition           ItemCondition  @default(GOOD)
  discrepancyReason   String? // If quantityOrdered != quantityDelivered

  // Audit
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  @@index([deliveryNoteId])
  @@index([itemId])
}

// Join table for Invoice <-> DeliveryNote (N:N)
model InvoiceDeliveryLink {
  id              Int          @id @default(autoincrement())

  invoiceId       Int
  invoice         Invoice      @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  deliveryNoteId  Int
  deliveryNote    DeliveryNote @relation(fields: [deliveryNoteId], references: [id], onDelete: Cascade)

  linkedAt        DateTime     @default(now())
  linkedBy        Int // User ID

  @@unique([invoiceId, deliveryNoteId])
  @@index([invoiceId])
  @@index([deliveryNoteId])
}

// ============================================
// FILE ATTACHMENT MODELS
// ============================================

enum VirusScanStatus {
  PENDING
  SCANNING
  CLEAN
  INFECTED
  FAILED
}

enum AttachableEntityType {
  PURCHASE_ORDER
  DELIVERY_NOTE
  INVOICE
  VENDOR
}

model FileAttachment {
  id              Int                  @id @default(autoincrement())
  filename        String // Original filename
  s3Key           String               @unique // UUID-based key in S3
  contentType     String // MIME type
  sizeBytes       Int
  checksum        String               @unique // SHA-256 hash

  virusScanStatus VirusScanStatus      @default(PENDING)
  virusScanResult String? // Details if INFECTED/FAILED

  uploadedAt      DateTime             @default(now())
  uploadedBy      Int // User ID
  uploader        User                 @relation(fields: [uploadedBy], references: [id], onDelete: SetNull)

  // Relationships
  links           FileAttachmentLink[]
  versions        FileVersion[]        @relation("OriginalFile")
  newVersions     FileVersion[]        @relation("NewVersion")

  @@index([checksum])
  @@index([uploadedBy])
  @@index([virusScanStatus])
}

// Polymorphic join table
model FileAttachmentLink {
  id               Int                  @id @default(autoincrement())

  fileAttachmentId Int
  fileAttachment   FileAttachment       @relation(fields: [fileAttachmentId], references: [id])

  entityType       AttachableEntityType
  entityId         Int // ID of PO/DN/Invoice/Vendor

  isActive         Boolean              @default(true) // Soft delete

  attachedAt       DateTime             @default(now())
  attachedBy       Int // User ID

  @@unique([fileAttachmentId, entityType, entityId, isActive]) // Prevent duplicate active links
  @@index([entityType, entityId, isActive])
  @@index([fileAttachmentId])
}

model FileVersion {
  id                Int            @id @default(autoincrement())

  originalFileId    Int // The very first version's ID
  originalFile      FileAttachment @relation("OriginalFile", fields: [originalFileId], references: [id])

  newFileId         Int            @unique // The replacement file's ID
  newFile           FileAttachment @relation("NewVersion", fields: [newFileId], references: [id])

  previousVersionId Int? // NULL for first replacement
  versionNumber     Int

  replacedAt        DateTime       @default(now())
  replacedBy        Int // User ID

  @@index([originalFileId])
  @@unique([originalFileId, versionNumber])
}

// ============================================
// INVOICE VALIDATION MODELS
// ============================================

enum ValidationRuleType {
  DUPLICATE_INVOICE_NUMBER
  MISSING_INVOICE_NUMBER
  AMOUNT_THRESHOLD_EXCEEDED
  ROUND_AMOUNT_PATTERN
  PO_AMOUNT_VARIANCE
  PO_ITEM_MISMATCH
  DELIVERY_NOTE_MISMATCH
  PRICE_VARIANCE
}

enum ValidationSeverity {
  INFO
  WARNING
  CRITICAL
}

enum ValidationStatus {
  FLAGGED
  REVIEWED
  DISMISSED
  OVERRIDDEN
}

model InvoiceValidation {
  id          Int                  @id @default(autoincrement())
  invoiceId   Int
  invoice     Invoice              @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  ruleType    ValidationRuleType
  severity    ValidationSeverity
  status      ValidationStatus     @default(FLAGGED)
  details     Json                 // Flexible validation details
  metadata    Json?                // Additional context

  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  reviewedAt  DateTime?
  reviewedBy  Int?

  override    ValidationOverride?

  @@index([invoiceId])
  @@index([status])
  @@index([severity])
  @@index([ruleType])
  @@index([invoiceId, status])
  @@index([status, severity, createdAt])
}

model ValidationRule {
  id          Int                  @id @default(autoincrement())
  ruleType    ValidationRuleType   @unique
  name        String
  description String
  enabled     Boolean              @default(true)
  severity    ValidationSeverity   @default(WARNING)
  config      Json?                // Rule-specific configuration

  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  @@index([enabled])
}

model ValidationOverride {
  id           Int               @id @default(autoincrement())
  validationId Int               @unique
  validation   InvoiceValidation @relation(fields: [validationId], references: [id], onDelete: Cascade)

  userId       Int
  user         User              @relation(fields: [userId], references: [id])
  reason       String            // Min 10 chars, required

  createdAt    DateTime          @default(now())

  @@index([userId])
  @@index([createdAt])
}

// ============================================
// ANALYTICS FOUNDATION MODELS
// ============================================

enum RecommendationType {
  COST_OPTIMIZATION
  VENDOR_SWITCH
  CONSOLIDATION
  WASTE_PREVENTION
  RISK_ALERT
  SEASONAL_OPPORTUNITY
  INVENTORY_REORDER
  PRICE_NEGOTIATION
}

enum RecommendationStatus {
  PENDING
  VIEWED
  DISMISSED
  APPLIED
  EXPIRED
}

model SpendingMetric {
  id             Int      @id @default(autoincrement())

  // ARCHITECTURE: Use dimension hash for uniqueness instead of composite key with NULLs
  // PostgreSQL treats NULL != NULL, so composite unique on nullable fields doesn't work properly
  dimensionHash  String   @unique // SHA256 of concatenated dimension values

  // Dimensions
  date           DateTime // Day-level granularity
  itemId         Int?
  item           Item?    @relation(fields: [itemId], references: [id])
  vendorId       Int?
  vendor         Vendor?  @relation(fields: [vendorId], references: [id])
  branchId       Int?
  branch         Branch?  @relation(fields: [branchId], references: [id])
  departmentId   Int?
  department     Department? @relation(fields: [departmentId], references: [id])
  costCenterId   Int?
  costCenter     CostCenter? @relation(fields: [costCenterId], references: [id])

  // Metrics
  totalAmount    Float
  invoiceCount   Int
  quantity       Int?
  avgUnitPrice   Float?

  // Metadata
  computedAt     DateTime @default(now())

  @@index([date, branchId, itemId])
  @@index([date, vendorId, itemId])
  @@index([itemId, branchId, date])
  @@index([vendorId, date])
  @@index([branchId, date])
  @@index([departmentId, date])
}

model PurchasePattern {
  id                  Int      @id @default(autoincrement())

  itemId              Int
  item                Item     @relation(fields: [itemId], references: [id])
  branchId            Int?
  branch              Branch?  @relation(fields: [branchId], references: [id])

  // Pattern metrics
  avgOrderCycleDays   Float    // e.g., 4.2 days
  avgOrderQuantity    Float
  avgOrderAmount      Float
  stdDevQuantity      Float    // For anomaly detection
  stdDevAmount        Float

  // Trend indicators
  isIncreasing        Boolean  @default(false)
  isDecreasing        Boolean  @default(false)
  isSeasonal          Boolean  @default(false)
  seasonalityPattern  String?  @db.Text // JSON: monthly patterns

  // Metadata
  lastOrderDate       DateTime?
  nextPredictedOrder  DateTime?
  confidenceScore     Float    @default(0.5) // 0-1

  basedOnInvoices     Int      // Sample size
  analysisStartDate   DateTime
  analysisEndDate     DateTime
  lastUpdated         DateTime @updatedAt

  @@unique([itemId, branchId])
  @@index([branchId])
  @@index([lastOrderDate])
  @@index([nextPredictedOrder])
}

model PriceSnapshot {
  id        Int      @id @default(autoincrement())

  itemId    Int
  item      Item     @relation(fields: [itemId], references: [id])
  vendorId  Int
  vendor    Vendor   @relation(fields: [vendorId], references: [id])
  branchId  Int?
  branch    Branch?  @relation(fields: [branchId], references: [id])

  price     Float
  date      DateTime

  // Statistics (computed from network)
  networkAvgPrice      Float?
  networkMinPrice      Float?
  networkMaxPrice      Float?
  varianceFromAvg      Float?  // Percentage

  @@index([itemId, date])
  @@index([vendorId, itemId, date])
  @@index([branchId, itemId, date])
  @@index([date])
}

model Recommendation {
  id              Int                @id @default(autoincrement())

  type            RecommendationType
  category        String             // "Cost Optimization", "Risk Alert", etc.

  title           String             // "Switch vendor for Chicken Breast"
  description     String             @db.Text
  reasoning       String             @db.Text // Why this recommendation

  // Impact estimates
  estimatedSavings   Float?
  confidenceScore    Float       @default(0.5) // 0-1
  priority           Int         @default(3)   // 1=critical, 5=low

  // Context data (JSON)
  context         String             @db.Text // Item IDs, vendor IDs, etc.

  // State
  status          RecommendationStatus @default(PENDING)
  createdBy       String             @default("SYSTEM")

  // User interaction
  viewedAt        DateTime?
  viewedBy        Int?               // User ID
  dismissedAt     DateTime?
  dismissedBy     Int?
  dismissReason   String?
  appliedAt       DateTime?
  appliedBy       Int?

  // Metadata
  createdAt       DateTime           @default(now())
  expiresAt       DateTime?

  @@index([status, priority])
  @@index([type, status])
  @@index([createdAt])
  @@index([expiresAt])
  @@index([status, priority, createdAt])  // Optimizes common query pattern: list by status, sorted by priority and date
}
